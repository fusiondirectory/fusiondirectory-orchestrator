<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Orchestrator Client</title>
  </head>
  <body>

    <main class="container">
      <div class="grid">
        <div>
          <form>
            <label for="username">
              Username <input name="username" id="username">
            </label>
            <label for="password">
              Password <input type="password" name="password" id="password">
            </label>
            <button id="login">Log in</button>
          </form>
          <button id="getTasks" style="display: none">Get tasks</button>
          <button id="getTasksMail" style="display: none">Get  mail tasks</button>
          <button id="sendMail" style="display: none">Send mail</button>
          <button id="logout" style="display: none">Log out</button>
        </div>
      </div>
    </main>

    <h1>Tasks List</h1>
    <table>
      <tbody id="task-list">
      </tbody>
    </table>

    <script>
      const loginForm = document.forms[0];
      const loginButton = document.getElementById("login");
      const getTasksButton = document.getElementById("getTasks");
      const getTasksMailButton = document.getElementById("getTasksMail");
      const sendMailButton = document.getElementById("sendMail");
      const logoutButton = document.getElementById("logout");



      /**
       * Login
       */
      loginForm.addEventListener('submit', async (e) => {

        e.preventDefault();

        const response = await fetch('https://myiam.example.com/orchestrator/api/login', {
          method: 'POST',
          body: JSON.stringify({
            username: loginForm.username.value,
            password: loginForm.password.value
          })
        });

        const json = await response.text();
        const obj = JSON.parse(json);

        if (response.status == 200) {

          localStorage.setItem("access_token", obj.access_token);
          localStorage.setItem("refresh_token", obj.refresh_token);

          loginForm.style.display = "none";
          logoutButton.style.display = "block";
          getTasksButton.style.display = "block";
          getTasksMailButton.style.display = "block";
          sendMailButton.style.display = "block";

        } else {
          alert(obj.message);
        }
      });

      /**
       * Logout
       */
      logoutButton.addEventListener('click', async (e) => {

        e.preventDefault();

        clearTable();
        logoutButton.style.display = "none";
        getTasksButton.style.display = "none";
        getTasksMailButton.style.display = "none";
        sendMailButton.style.display = "none";

        const response = await fetch('https://myiam.example.com/orchestrator/api/logout', {
          method: 'POST',
          body: JSON.stringify({
            token: localStorage.getItem("refresh_token")
          })
        });

        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");

        loginForm.style.display = "block";
      });

      /**
       * Helper functions
       */

      // Function to clear the table
      function clearTable() {
        const taskList = document.getElementById("task-list");
        taskList.innerHTML = "";
      }

      /**
       * Get tasks
       */
      getTasksButton.addEventListener('click', async (e) => {

        e.preventDefault();

        const response = await fetch("https://myiam.example.com/orchestrator/api/tasks", {
          method: 'GET',
          headers: {
            "Authorization": "Bearer " + localStorage.getItem("access_token")
          }
        });

        const json = await response.text();
        // obj can be iterated later on to get better html content.
        const obj = JSON.parse(json);

        clearTable();

        if (response.status == 200) {

          // Get the table element
          let table = document.getElementById("task-list");

          // Create a header row for the table
          let headerRow = table.insertRow();
          let headers = ["Task Name", "Task Type", "Name"];

          for (let i = 0; i < headers.length; i++) {
            let header = document.createElement("th");
            header.innerHTML = headers[i];
            headerRow.appendChild(header);
          }

          // Iterate over the tasks and create rows in the table
          const taskList = document.getElementById("task-list");
          for (let i = 0; i < obj.count; i++) {
            const task = obj[i.toString()];
            const taskName = task.cn[0];
            const objectClasses = Array.isArray(task.objectclass) ? task.objectclass.join(", ") : task.objectclass;
            const dn = task.dn;
            const row = document.createElement("tr");
            row.innerHTML = `<td>${taskName}</td><td>${objectClasses}</td><td>${dn}</td>`;
            taskList.appendChild(row);
          }

          // else refresh token.
        } else {
          updateToken();
        }        

      });

      /**
       * Get tasks mail
       */
      getTasksMailButton.addEventListener('click', async (e) => {

        e.preventDefault();

        const response = await fetch("https://myiam.example.com/orchestrator/api/tasks/mail", {
          method: 'GET',
          headers: {
            "Authorization": "Bearer " + localStorage.getItem("access_token")
          }
        });

        clearTable();
        const json = await response.text();
        // obj can be iterated later on to get better html content.
        const obj = JSON.parse(json);

        if (response.status == 200) {

          // Get the table element
          let table = document.getElementById("task-list");

          // Create a header row for the table
          let headerRow = table.insertRow();
          let headers = ["Task", "Status", "Type", "Reference", "Assigned To", "Schedule"];

          for (let i = 0; i < headers.length; i++) {
            let header = document.createElement("th");
            header.innerHTML = headers[i];
            headerRow.appendChild(header);
          }
          // Create a row for each task in the JSON data and populate the table
          for (let i = 0; i < obj.length; i++) {
            let task = obj[i];

            // Create a new row for the task
            let row = table.insertRow();

            // Create a cell for each property in the task object
            let taskNameCell = row.insertCell();
            taskNameCell.innerHTML = task.cn["0"];

            let statusCell = row.insertCell();
            statusCell.innerHTML = task.fdtasksgranularstatus["0"];

            let typeCell = row.insertCell();
            typeCell.innerHTML = task.fdtasksgranulartype["0"];

            let referenceCell = row.insertCell();
            referenceCell.innerHTML = task.fdtasksgranularref["0"];

            let assignedToCell = row.insertCell();
            assignedToCell.innerHTML = task.fdtasksgranularmail["0"];

            let scheduleCell = row.insertCell();
            scheduleCell.innerHTML = task.fdtasksgranularschedule["0"];
          }

          // else refresh token.
        } else {

          updateToken();   
        }


      });


      /**
       * Send Mail
       */
      sendMailButton.addEventListener('click', async (e) => {

        e.preventDefault();
        
        clearTable();

        const response = await fetch("https://myiam.example.com/orchestrator/api/tasks/mail", {
          method: 'PATCH',
          headers: {
            "Authorization": "Bearer " + localStorage.getItem("access_token")
          }
        });

        const json = await response.text();
        
        // obj can be iterated later on to get better html content.
        const obj = JSON.parse(json);

        if (response.status == 200) {

          // Get the table element
          let table = document.getElementById("task-list");

          // Create a header row for the table
          let headerRow = table.insertRow();
          let headers = ["Status"];

          for (let i = 0; i < headers.length; i++) {
            let header = document.createElement("th");
            header.innerHTML = headers[i];
            headerRow.appendChild(header);
          }
          
          // Create a row for each task in the JSON data and populate the table
          for (let i = 0; i < obj.length; i++) {
            let task = obj[i];

            // Create a new row for the task
            let row = table.insertRow();

            // Create a cell for each property in the task object
            let statusCell = row.insertCell();
            statusCell.innerHTML = obj[i];
          }

          // refresh token automatically. 
        } else {

          updateToken();      
        }

      });

      async function updateToken () {

        console.log("Access token expired, requesting new one");
        const response = await fetch('https://myiam.example.com/orchestrator/api/refresh', {
          method: 'POST',
          body: JSON.stringify({
            token: localStorage.getItem("refresh_token")
          })
        });

        const json = await response.text();
        const obj = JSON.parse(json);

        if (response.status == 200) {

          console.log("Got new access token and refresh token");
          localStorage.setItem("access_token", obj.access_token);
          localStorage.setItem("refresh_token", obj.refresh_token);
        }
      }


    </script>
  </body>
</html>
